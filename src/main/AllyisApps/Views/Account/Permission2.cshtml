@using AllyisApps.ViewModels.Auth;

@model PermissionsManagementViewModel

@{
    ViewBag.Title = AllyisApps.Resources.Views.Account.Strings.Permissions;
    Layout = "~/Views/Shared/_Layout.cshtml";

    int productId = Model.TimeTrackerId;
    var query = (from entry in Model.Subscriptions where entry.ProductId == productId select entry).FirstOrDefault();
    bool hasTimeTracker = query != null ? true : false;

    Dictionary<int, string> orgRoles = new Dictionary<int, string>
    {
        { (int)AllyisApps.Services.OrganizationRole.Member, AllyisApps.Resources.Views.Account.Strings.Member },
        { (int)AllyisApps.Services.OrganizationRole.Owner, AllyisApps.Resources.Views.Account.Strings.Owner }
    };
    Dictionary<int, string> ttRoles = new Dictionary<int, string>
    {
        { (int)AllyisApps.Services.ProductRole.TimeTrackerUser, AllyisApps.Resources.Views.Account.Strings.User },
        { (int)AllyisApps.Services.ProductRole.TimeTrackerManager, AllyisApps.Resources.Views.Account.Strings.Manager },
        { (int)AllyisApps.Services.ProductRole.NotInProduct, AllyisApps.Resources.Views.Account.Strings.Unassigned }
    };
}

@Html.AntiForgeryToken()

<div class="panel panel-default">
    <div class="panel-heading">
    </div>
    <div class="panel-body" style="padding: 0px;">
        <table class="table table-hover table-condensed">
            <thead>
                <tr class="no-border">
                    <th></th>
                    <th>User</th>
                    <th>Organization Role</th>
                    @if (hasTimeTracker)
                    {
                        <th>TimeTracker Role</th>
                    }
                </tr>
                <tr class="double-bottom-border">
                    <td style="text-align: right;">Filter:</td>
                    <td>
                        <input type="search" placeholder="@AllyisApps.Resources.Views.Account.Strings.UserSearchPlaceholder" id="userSearch" class="form-control"/>
                    </td>
                    <td>
                        <select id="orgRoleFilter">
                            <option>@AllyisApps.Resources.Views.Account.Strings.Any</option>
                            @foreach (string role in orgRoles.Values)
                            {
                                <option>@role</option>
                            }
                        </select>
                    </td>
                    @if (hasTimeTracker)
                    {
                        <td>
                            <select id="ttRoleFilter">
                                <option>@AllyisApps.Resources.Views.Account.Strings.Any</option>
                                @foreach (string ttrole in ttRoles.Values)
                                {
                                    <option>@ttrole</option>
                                }
                            </select>
                        </td>
                    }
                </tr>
            </thead>
            
            @foreach (UserPermissionsManagement user in Model.UserPermissions)
            {
                <tr class="userRow">
                    <td id="checked" style="text-align: center;">
                        <input type="checkbox" id="@(user.UserId + "_check")" />
                    </td>
                    <td id="name">@user.UserName</td>
                    <td id="orgRole">@orgRoles[user.OrganizationRoleId]</td>
                    @if (hasTimeTracker)
                    {
                        <td id="ttRole">@ttRoles[user.SubscriptionRoles.Where(s => s.ProductId == productId).Single().ProductRoleId]</td>
                    }
                </tr>
            }

            @*This last blank row is just an easy way to have a border at the bottom of the table content*@
            <tr>
                <td></td>
                <td></td>
                <td></td>
                @if (hasTimeTracker) { <td></td> }
            </tr>
        </table>
    </div>
    <div class="panel-footer">
        <span class="btn" style="visibility:hidden">Placeholder</span>
        <div class="pull-right">
            <a href="" class="btn btn-primary">@AllyisApps.Resources.Views.Account.Strings.Save</a>
            @Html.ActionLink(AllyisApps.Resources.Views.Account.Strings.Back, ActionConstants.Manage, ControllerConstants.Account, null, new { @class = "btn btn-default" })
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        hasTT = '@hasTimeTracker' == 'True';
        anyValue = "@AllyisApps.Resources.Views.Account.Strings.Any";
    </script>
    <script src="~/Scripts/allyis-account-permission2.js" type="text/javascript"></script>
    @*@Scripts.Render("~/bundles/AccountPermission2");*@
}
