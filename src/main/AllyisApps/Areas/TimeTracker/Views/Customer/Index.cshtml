@using AllyisApps.ViewModels.TimeTracker.Customer;
@using AllyisApps.ViewModels.TimeTracker.Project;
@using AllyisApps.Services;

@model ManageCustomerViewModel

@{
    DisplayHints.PageBodyId = "tt-customer";
    ViewBag.TitleBar = AllyisApps.Resources.TimeTracker.Views.Customer.Strings.CustomerList;
    Layout = "~/Areas/TimeTracker/Views/Shared/_Layout.cshtml";
    var customerCount = 0;
    var empty = new EditCustomerInfoViewModel() { OrganizationId = Model.OrganizationId };
    var emptyProj = new EditProjectViewModel();
}

<div class="allyis-action-buttons-top">
    <a href="@Url.Action(ActionConstants.Create, ControllerConstants.Customer)" class="btn btn-default">@AllyisApps.Resources.TimeTracker.Views.Customer.Strings.AddCustomer <i class="fa fa-plus"></i></a>

    <div class="pull-right">
        <input type="text" id="SearchInput" placeholder=@AllyisApps.Resources.TimeTracker.Views.Customer.Strings.SearchPlaceholder class="form-control">
    </div>
</div>
@if (Model.Customers.Count() > 0)
{
    <div class="panel-group customer-list" id="customer-panel" role="tablist">
        @foreach (CustomerProjectViewModel customer in Model.Customers)
        {
            var collapseTarget = string.Format("customerNumber{0}", customer.CustomerInfo.CustomerId);
            var customerDetailsTarget = string.Format("custDetails{0}", customerCount);
            var projectCount = customer.Projects.Count();
            var projectCountLabel = projectCount == 1 ? "project" : "projects";
            <div class="panel panel-customer">
                <div class="panel-heading" role="tab">
                    <a class="accordion-toggle collapsed" role="button" data-toggle="collapse" data-target="#@collapseTarget" data-keyboard="true" href="#">
                        <h4 class="panel-title">
                            <i class="chevron"></i>
                            <span class="searchable">@customer.CustomerInfo.Name</span>
                            <span class="small text-muted">(@projectCount @projectCountLabel)</span>
                        </h4>
                    </a>
                    <a href="@Url.Action(ActionConstants.Edit, ControllerConstants.Customer,  new {id = customer.CustomerInfo.CustomerId})" class="pull-right">
                        <i class="fa fa-lg fa-fw fa-cog"></i>
                    </a>
                    <a href="@Url.Action(ActionConstants.Delete, ControllerConstants.Customer, new {id = customer.CustomerInfo.CustomerId})" class="pull-right" style="margin-top:4px;" onclick="return confirm('Are you sure you wish to delete the customer @customer.CustomerInfo.Name?')">
                        <i class="fa fa-2x fa-fw fa-times" style="color:#333;"></i>
                    </a>
                </div>
                <div id="@collapseTarget" class="panel-collapse search-expand collapse panel-two-table-wrap" role="tabpanel">
                    <div style="width: 100%">
                        <div class="list-group list-group-with-buttons project-list">
                            @foreach (ProjectInfo project in customer.Projects)
                            {
                                var projectID = string.Format("project{0}", project.ProjectId);
                                <div class="list-group-item" id="@projectID">
                                    <a class="accordion-toggle collapsed" href="@Url.Action(ActionConstants.Details, ControllerConstants.Project, new { projectId = project.ProjectId })">

                                        <span class="searchable projectname">@project.Name</span>
                                    </a>
                                    @*// This list group scheme is not possible. Review alternatives and then uncomment.*@
                                    <a href="@Url.Action(ActionConstants.Edit, ControllerConstants.Project, new {id = project.ProjectId})" class="pull-right"><i class="fa fa-lg fa-fw fa-cog"></i></a>
                                    <a href="@Url.Action(ActionConstants.Delete, ControllerConstants.Project, new {id = project.ProjectId})" class="pull-right" style="margin-left:2px;" onclick="return confirm('Are you sure you wish to Delete the project @project.Name?')">
                                        <i class="fa fa-times"></i>
                                    </a>
                                </div>
}
                            <div class="list-group-item">
                                <a href="@Url.Action(ActionConstants.Create, ControllerConstants.Project, new {id=customer.CustomerInfo.CustomerId})" class="list-group-item-info pull-right"><i class="fa fa-lg fa-fw fa-plus"></i> Add Project</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>customerCount += 1;
        }
    </div>
    <div class="allyis-action-buttons">
        <a href="@Url.Action(ActionConstants.Create, ControllerConstants.Customer)" class="btn btn-default">@AllyisApps.Resources.TimeTracker.Views.Customer.Strings.AddCustomer <i class="fa fa-plus"></i></a>
    </div>
}
@using (Html.BeginForm(ActionConstants.Import, ControllerConstants.Customer, null, FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken();
    <div class="bulk" style="float:left; clear:right; margin:20px">
        <p>@AllyisApps.Resources.TimeTracker.Views.Customer.Strings.ImportCustomers</p>
        <div style="float:left; min-width:70%">
            <input type="file" id="upload-box" name="upload" style="display:none;"
                   onchange="$('#upload-file-name-display').val($(this).val().replace('C:\\fakepath\\', ''));" />
            <input id="upload-file-name-display" class="form-control"
                   onchange="$('#upload-file-name-display').val($(this).val().replace('C:\\fakepath\\', ''));" />
        </div>
        <div style="float:left; min-width: 30% ">
            <a class="btn btn-primary" style ="margin-left:10px"onclick="$('input[id=upload-box]').click();">@AllyisApps.Resources.Views.Account.Strings.ChooseFile</a>
            <input style="margin-left: 5px" type="submit" id="upload-button" value="@AllyisApps.Resources.Views.Account.Strings.Upload" class="btn btn-primary" />
        </div>
    </div>
}

@section Scripts{
    @Scripts.Render("~/bundles/TTCustomerIndex");
}