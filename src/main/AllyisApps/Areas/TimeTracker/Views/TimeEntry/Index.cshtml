@using AllyisApps.Areas.TimeTracker.Core;
@using AllyisApps.Areas.TimeTracker.Models;
@using AllyisApps.Services;
@using AllyisApps.Utilities;
@model TimeEntryOverDateRangeViewModel
@{
    DisplayHints.BreadcrumbNavPartialLocation = "~/Areas/TimeTracker/Views/Shared/_BreadcrumbNavPartial.cshtml";
    DisplayHints.LayoutThemeBundle = "~/Content/Timetracker";
    ViewBag.startOfWeek = Model.StartOfWeek;
    ViewBag.TitleBar = AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.TrackTime;
    Layout = "~/Views/Shared/_LayoutSidebar.cshtml";
}

<div class="row">
    @using (Html.BeginForm(ActionConstants.Index, ControllerConstants.TimeEntry, FormMethod.Get, htmlAttributes: new { @class = "form-inline col-xs-12", @style = "margin-bottom: 20px;" }))
    {
        <input id="UserId" name="UserId" type="hidden" value="@Model.EntryRange.UserId" />
        <input id="StartDate" name="StartDate" type="hidden" value="@Model.EntryRange.StartDate" />
        <input id="EndDate" name="EndDate" type="hidden" value="@Model.EntryRange.EndDate" />
        <div class="form-group pull-left" style="margin-bottom: 15px;">
            <a href="@Url.Action(ActionConstants.Export, ControllerConstants.TimeEntry, routeValues: new
                {
                    userId = Model.EntryRange.UserId,
                    startingDate = Model.EntryRange.StartDate,
                    endingDate = Model.EntryRange.EndDate
                })">
                @*<input type="button" value="Export" class="btn btn-primary">*@
                <span class="btn btn-primary" style="margin-right: 15px;">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Export</span>
            </a>
        </div>
        <!-- Temp fix for Users button for smaller viewports -->
        <div class="form-group pull-right">
            <button type="button" class="btn btn-primary visible-xs" data-toggle="offcanvas" style="margin: 0 0 0 15px">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Users</button>
        </div>
        @*To be moved to a separate settings page*@

        <div id="date-select" class="form-group pull-right">
            <div class="input-group">

                <div class="input-group-btn">
                    <a class="btn btn-primary" title=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Previous
                       href="javascript: void(0);" onclick="return drp_prevWeek()">
                        <i class="fa fa-chevron-left"></i>
                    </a>
                    <a class="btn btn-primary" title=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Current
                       href="@Url.Action(ActionConstants.Index, routeValues: new { userId = Model.EntryRange.UserId })">
                        <i class="glyphicon glyphicon-flash"></i>
                    </a>
                    <a class="btn btn-primary" title=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Next
                       href="javascript: void(0);" onclick="return drp_nextWeek()">
                        <i class="fa fa-chevron-right"></i>
                    </a>
                </div>
                <input type="text" name="daterange" id="daterange" class="form-control" value="" />
                @*<div class="input-group-btn">
                    <input type="submit" value=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.View class="btn btn-primary" style="width: 56px" />
                </div>*@
            </div>
        </div>
    }
</div>

@Html.Partial("_AjaxTimeEntries", Model.EntryRange)

@{ViewBag.SidebarToggleText = AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Details;
ViewBag.RenderSidebar = true;}
@if (Model.CanManage)
{
    ViewBag.SidebarToggleText = AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Users;
}

@section sidebar {
    <div class="panel panel-info" id="timesheet-summary">
        <div class="panel-heading">
            <h1 class="panel-title">@Model.CurrentUser.FirstName @Model.CurrentUser.LastName</h1>
        </div>

        <table class="table table-condensed">
            @foreach (ProjectHours ph in Model.ProjectHours)
            {
                <tr>
                    <td>
                        @ph.Project.ProjectName
                    </td>
                    <td>
                        @ph.GetHoursInHoursMinutes()
                    </td>
                </tr>
            }
            <tr>
                <td>
                    <strong>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Total</strong>
                </td>
                <td>
                    <strong>@Model.GrandTotal.GetHoursInHoursMinutes()</strong>
                </td>
            </tr>
        </table>
    </div>
    @if (Model.CanManage)
    {
        <div class="panel panel-info" id="TimeSheet-LockDate">
            <div class="panel-heading">
                <h1 class="panel-title">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.LockDate</h1>
            </div>
            @using (Html.BeginForm(ActionConstants.SetLockDate, ControllerConstants.TimeEntry, FormMethod.Post))
            {
                <input id="UserId" name="UserId" type="hidden" value="@Model.EntryRange.UserId" />
                <input id="StartDate" name="StartDate" type="hidden" value="@Model.EntryRange.StartDate" />
                <input id="EndDate" name="EndDate" type="hidden" value="@Model.EntryRange.EndDate" />
                @Html.TextBoxFor(m => m.LockDate, new { name = "LockDate", id = "LockDate", @class = "form-control" })
                //<input type="text" name="LockDate" id="LockDate" class="form-control" value="" onSubmit="alert(LockDate.value);" />
            }
        </div>
    }

    @if (Model.CanManage)
    {
        <div class="panel panel-info">
            <div class="panel-heading">
                <h1 class="panel-title">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.MemberList</h1>
                <input id="viewasuser-search" type="text" class="form-control" placeholder=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.SearchPlaceholder />
            </div>
            <div id="viewasuser-list" class="list-group allyis-search" style="max-height: 50vh; overflow-y: auto;">
                @{ var count = 0;
                    var pageCount = 1;
                    var hide = "";
                    foreach (UserInfo user in Model.Users)
                    {
                        pageCount = 1 + (count / Model.PageUserSize);
                        if (count >= 0 && count <= (Model.PageUserSize - 1))
                        {
                            hide = "flex";
                        }
                        else
                        {
                            hide = "none";
                        }

                        string active = "";
                        var resetBackground = "this.style.backgroundColor=\"#FFFFFF\"";
                        if (user.UserId == Model.EntryRange.UserId)
                        {
                            active = "list-group-item-info";
                            resetBackground = "this.style.backgroundColor=\"#d9edf7\"";
                        }
                        <div data-page="@pageCount" class="@(active)"
                             onmouseover='this.style.backgroundColor="#c4e3f3"' onmouseout="@resetBackground"
                             style="width: 95%; display: @hide; justify-content: flex-end;">
                            <a class="col-xs-11 text-left" data-search="@user.Email"
                               href="@Url.Action(ActionConstants.Index, routeValues: new
                            {
                                userId = user.UserId,
                                startDate = Model.EntryRange.StartDate,
                                endDate = Model.EntryRange.EndDate
                            })"
                               style="text-decoration: none; color: #000000;">
                                @user.FirstName @user.LastName
                            </a>
                            <a href="@Url.Action(ActionConstants.UserEdit, routeValues: new {
                                userId = user.UserId })"
                               style="text-decoration: none; color: #0066AA;"><i class="fa fa-cog"></i></a>
                        </div>count++;
                    }
                }
            </div>
            <div id="footPager" class="panel-footer" style="display: flex; justify-content: space-around; flex-wrap: wrap">
                @if (Model.Users.Any())
                {
                    var page = 1;
                    <input class="btn btn-primary btn-xs" id="page @page" name="pageButton" type="button" value="@page" onClick="showPage(@page)" disabled="" />page++;
                    while (page <= Model.UserPageCount)
                    {
                        <input class="btn btn-primary btn-xs" id="page @page" name="pageButton" type="button" value="@page" onClick="showPage(@page)" />page++;
                    }
                }
            </div>
        </div>
    }
}

@section css
{
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="~/Content/jquery.comiseo.daterangepicker.css" />
}

@section scripts
{
    @*Date range picker dependencies:*@
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/moment")

    <script type="text/javascript">
        var model_startdate = @Model.EntryRange.StartDate;
        var model_enddate = @Model.EntryRange.EndDate;
        var model_lockdate = @Model.LockDate;
        var pageSize = @Model.PageUserSize;
        var page_container_id = "viewasuser-list";
        var page_item_tag = "div";
    </script>
    @Scripts.Render("~/bundles/daterangepicker")
    @Scripts.Render("~/bundles/pageswithsearch")
    @Scripts.Render("~/bundles/TTTimeEntryIndex")
}