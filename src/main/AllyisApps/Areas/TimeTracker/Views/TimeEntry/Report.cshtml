@using AllyisApps.Areas.TimeTracker.Models;
@using AllyisApps.Core;

@model ReportViewModel

@{
    ViewBag.Title = AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Report;
    DisplayHints.BreadcrumbNavPartialLocation = "~/Areas/TimeTracker/Views/Shared/_BreadcrumbNavPartial.cshtml";
    DisplayHints.LayoutThemeBundle = "~/Content/Timetracker";
    ViewBag.OrganizationId = Model.OrganizationId;
    Layout = "~/Views/Shared/_LayoutSidebar.cshtml";
}

<div class="row report-wrap">
    <div class="col-md-10 col-md-push-1 col-lg-8 col-lg-push-2">
        <div class="row">
            @using (Html.BeginForm(ActionConstants.ViewReport, ControllerConstants.TimeEntry, FormMethod.Post, htmlAttributes: new { @id = "reportForm" }))
            {
                @Html.Hidden("OrganizationId", Model.OrganizationId)
                <!--Get users By subscriptionUser-->
                <!--Default selection: current user-->if (Model.CanManage)// was previously: (Permissions.Can(ProductAction.TimeTrackerCreateReportOthers, Model.OrganizationId, DB Helper.Instance.GetProductIDByName("TimeTracker")))
                {
                    <div class="list-left container">
                        <label for="UserSelect">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Employees</label>
                        @Html.DropDownList("UserSelect",
                                              Model.UserView,
                                              htmlAttributes: new { @class = "form-control", multiple = "multiple", size = "9" })
                    </div>
}
                else
                {
                    <div class="list-left container" style="display: none;">
                        <label for="UserSelect">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Employees</label>
                        @Html.DropDownList("UserSelect",
                                              Model.UserView,
                                              htmlAttributes: new { @class = "form-control", /*disabled = "disabled",*/ multiple = "multiple", size = "9", style = "display: none;" })
                    </div>
}
                <div class="options-right container">
                    <div class="row">
                        <div class="form-group col-md-6 col-lg-6">
                            <!--Get Customers by OrganizationId-->
                            <label for="CustomerSelect">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Customers</label>
                            @Html.DropDownList("CustomerSelect",
                                              Model.CustomerView,
                                              htmlAttributes: new { @class = "form-control", @id = "ddl-customers" })
                        </div>
                        @if (Model.Selection.CustomerId == 0)
                        {
                            <div class="form-group col-md-6 col-lg-6">
                                <label for="ddl-projects">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Projects</label>
                                <!--Get Projects by OrgID-->
                                @Html.DropDownList("ProjectSelect",
                                              Model.ProjectView,
                                              htmlAttributes: new { @class = "form-control", @id = "ddl-projects", @disabled = "disabled" })
                            </div>
}
                        else
                        {
                            <div class="form-group col-md-6 col-lg-6">
                                <label for="ddl-projects">@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Projects</label>
                                @Html.DropDownList("ProjectSelect",
                                              Model.ProjectView,
                                              htmlAttributes: new { @class = "form-control", @id = "ddl-projects" })
                            </div>
}
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6 col-lg-6">
                            <label>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.DateRange</label>
                            <input type="hidden" id="DateRangeStart" name="DateRangeStart" value="@DateTime.Today.ToString("MM/dd/yyyy")" />
                            <input type="hidden" id="DateRangeEnd" name="DateRangeEnd" value="@DateTime.Today.ToString("MM/dd/yyyy")" />
                            <input type="text" name="daterange" id="daterange" class="form-control" value="" />
                        </div>
                        <br />
                        <div class="col-md-6 col-lg-6" style="display: flex; justify-content: space-around;">
                            <div>
                                <input class="btn btn-primary" type="submit" name="viewDataButton" value=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Preview />
                            </div>
                            @Html.Hidden("ShowExport", Model.ShowExport)
                            @if (Model.ShowExport)
                            {
                                <div>
                                    <input class="btn btn-primary" type="submit" name="viewDataButton" value=@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Export />
                                </div>
}
                        </div>
                    </div>
                </div>
                @Html.Hidden("PageNum", Model.PreviewPageNum)
}
        </div>
        <br />
        <!--Preview panel-->
        <div class="panel panel-default">
            <div class="panel-heading">
                @AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.LRP
                (<span id="data-view-sum">@Model.PreviewTotal</span>)
            </div>
            <div id="data-view" class="panel-body data-view">
                @if (Model.PreviewMessage == "")
                {
                    <table class="table table-hover table-condensed" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.LastName</th>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.FirstName</th>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Date</th>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Duration</th>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Project</th>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Customer</th>
                                <th>@AllyisApps.Resources.TimeTracker.Views.TimeEntry.Strings.Description</th>
                            </tr>
                        </thead>
                        <tbody id="preview-data">
                            @foreach (TablePreviewEntry pe in Model.PreviewEntries)
                            {
                                <tr name="preview-entry">
                                    <td>@pe.TimeEntry.LastName</td>
                                    <td>@pe.TimeEntry.FirstName</td>
                                    <td>@pe.TimeEntry.Date.ToShortDateString()</td>
                                    <td>@pe.TimeEntry.Duration</td>
                                    <td>@pe.ProjectName</td>
                                    <td>@pe.CustomerName</td>
                                    <td>@pe.TimeEntry.Description</td>
                                </tr>
}
                        </tbody>
                    </table>}
                else
                {
                    <p>
                        &hellip;
                    </p>}
            </div>
            <div id="data-message" class="panel-footer">
                @Model.PreviewMessage
            </div>
        </div>

        <!--Paging panel-->
        @using (Html.BeginForm(ActionConstants.ViewPage, ControllerConstants.TimeEntry, FormMethod.Post, htmlAttributes: new { @id = "viewPageForm" }))
        {
            <div class="panel panel-default" id="footPager" style="border: 0; display: flex; justify-content: space-around; flex-wrap: wrap;">
                @Html.Hidden("OrganizationId", Model.OrganizationId)
                @for (int u = 0; u < Model.Selection.Users.Count; u++)
                {
                    @Html.Hidden(string.Format("Users[{0}]", u), Model.Selection.Users[u])
                }
                @Html.Hidden("StartDate", Model.Selection.StartDate)
                @Html.Hidden("EndDate", Model.Selection.EndDate)
                @Html.Hidden("ShowExport", Model.ShowExport)
                @Html.Hidden("CustomerSelect", Model.Selection.CustomerId)
                @Html.Hidden("ProjectSelect", Model.Selection.ProjectId)
                @for (int i = 1; i <= Model.PreviewPageTotal; i++)
                {
                    if (i == Model.PreviewPageNum)
                    {
                        <input class="btn btn-primary btn-sm" id="page @i" name="pageButton" type="button" value="@i" disabled="disabled" />
                    }
                    else
                    {
                        <input class="btn btn-primary btn-sm" id="page @i" name="pageButton" type="submit" value="@i" />
                    }
                }
            </div>
        }
    </div>
</div>

@section css {
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="~/Content/jquery.comiseo.daterangepicker.css" />
}

@section scripts
{
    @*Date range picker dependencies:*@
    @Scripts.Render("~/bundles/jqueryui");
    @Scripts.Render("~/bundles/moment");

    <script type="text/javascript">
        var model_startofweek = @Model.StartOfWeek;
        var model_startdate = @Model.Selection.StartDate.Value;
        var model_enddate = @Model.Selection.EndDate.Value;
    </script>
    @Scripts.Render("~/bundles/daterangepicker");
    @Scripts.Render("~/bundles/TTTimeEntryReport");
}