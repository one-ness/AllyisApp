@model AllyisApps.ViewModels.ProductSubscriptionViewModel

@{
    Layout = "~/Views/Shared/_LayoutJustAForm.cshtml";
    ViewBag.Title = AllyisApps.Resources.Views.Account.Strings.Subscribe;
    ViewBag.Description = Model.ProductDescription;
    var userCount = Model.CurrentSubscription == null ? 5 : Model.CurrentSubscription.NumberOfUsers;
    var cost = (userCount - 5).ToString("c");
}

@using (Html.BeginForm("Subscribe", "Account", FormMethod.Post, new { @class = "form-inline" }))
{
    @*<input type="hidden" value="@Model.ProductId" name="productName" />*@
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.OrganizationId)
    @Html.HiddenFor(m => m.ProductId)
    @Html.HiddenFor(m => m.ProductName)
    @Html.Hidden("SelectedSku", 1)
    @Html.HiddenFor(m => m.PreviousSku)
    @Html.HiddenFor(m => m.StripeToken)
    @Html.Hidden("currentUserCount", (int)Model.CurrentUsers)
    <p>@AllyisApps.Resources.Views.Account.Strings.FirstUserOffer</p>
    <p id="notice" style="color:red"></p>
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default" style="min-width:350px;">
                    <div class="panel-heading">
                        <h2 style="margin-top: 0; margin-bottom: 0;">
                            @Model.ProductName
                        </h2>
                    </div>
                    <div class="panel-body">
                        <div class="col-xs-3">
                            <label>@AllyisApps.Resources.Views.Account.Strings.NumberOfUsers</label>
                        </div>
                        <div class="col-xs-3">
                            <input class="form-control" name="NumberOfUsers" type="number" min="5" step="5" id="user-count" value="@userCount" onchange="fixUserCount(this)" />
                        </div>
                        <div class="col-xs-3">
                            <label>@AllyisApps.Resources.Views.Account.Strings.Price</label>
                        </div>
                        <div class="col-xs-3">
                            <span id="sub-price">@cost</span>
                        </div>

                    </div>
                    <div class="panel-footer">
                        <div class="pull-right">
                            @Html.ActionLink(AllyisApps.Resources.Views.Account.Strings.Cancel, "Manage", "Account", routeValues: null, htmlAttributes: new { @class = "btn btn-default" })
                            <input type="submit" class="btn btn-primary" value=@AllyisApps.Resources.Views.Account.Strings.Save onClick="this.form.submit(); this.disabled=true; this.value='Saving...';">
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </div>
        </div>
}


@section Scripts {
    <script type="text/javascript">
        function confirmIfFreeAndChanged() {
            element = $("input[type='radio'][name='SelectedSku']:checked");
            if( element.length <= 0 ) {
                return false;
            }
            if( !!element.attr('free') && element.val() != @Model.PreviousSku && @Model.PreviousSku != 0) {
                return confirm("@AllyisApps.Resources.Views.Account.Strings.WarningWhenSwitchingToFreeSubscription");
            }
            return true;
        }

        function fixUserCount(){
            var count = $("#user-count").val();
            var result = parseInt(count) + 4 - ((count - 1) % 5);
            var currentUsers = parseInt($("#currentUserCount").val());
            if (result < currentUsers ){
                $("#notice").text("@AllyisApps.Resources.Views.Account.Strings.CannotReduceUserCount");
            }else{
                $("#notice").text("");
            }
            $("#user-count").val(result);
            var costOut = result - 5 > 0 ? result - 5 : 0;
            $("#sub-price").text("$" + costOut.toFixed(2));
            $("#SelectedSku").val(costOut == 0 ? 1 : 2);
        }
    </script>
}
