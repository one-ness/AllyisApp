@using AllyisApps.Areas.TimeTracker.Core;
@using AllyisApps.ViewModels.TimeTracker.TimeEntry;
@using AllyisApps.Services.Auth;
@using AllyisApps.Utilities;
@using System.Configuration;
@model ReviewViewModel

@{
	ViewBag.Title = Strings.Review;
	DisplayHints.BreadcrumbNavPartialLocation = "~/Areas/TimeTracker/Views/Shared/_BreadcrumbNavPartial.cshtml";
	DisplayHints.LayoutThemeBundle = "~/Content/Timetracker";
	ViewData["UserId"] = Model.UserId;
	ViewData["SubscriptionId"] = Model.SubscriptionId;
	ViewData["SubscriptionName"] = Model.SubscriptionName;
}

<div class="panel panel-default">
	<div class="panel-heading row" style="margin: 0; padding-left: 0; padding-right: 0;">
		<div class="col-xs-8"><h2 class="panel-title">Time Entry Totals for Date Range:</h2></div>
		<div class="col-xs-4">
			<div id="review-range" class="pull-right" style="display: inline; background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
				<i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
				<span></span> <b class="caret"></b>
			</div>
		</div>
	</div>
	<table class="table table-hover table-condensed table-responsive">
		<thead>
			<tr class="double-bottom-border">
				<th><input type="checkbox" class="check-all" check-all-tier="0"></th>
				<th></th>
				<th>Name</th>
				@foreach (string payClassName in Model.PayClasses.Select(x => x.PayClassName))
				{
					<th>@payClassName</th>
				}
				<th>Total</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var group in Model.TimeEntriesByUser)
			{
				<tr>
					<td><input type="checkbox" class="check check-all" check-tier="0" check-all-tier="@group.Key"></td>
					<td><i class="fa fa-chevron-down toggle-on-click toggle-row-display-controller" rowId=@group.Key style="cursor:pointer"></i></td>
					<td>@group.First().FirstName @group.First().LastName</td>
					@foreach (int payClassId in Model.PayClasses.Select(x => x.PayClassId))
					{
						<td>@Model.TimeEntryTotalsByUserByPayClass[group.Key][payClassId]</td>
					}
					<td>@group.Sum(entry => entry.Duration)</td>
				</tr>
				foreach (var timeEntry in group)
				{
					<tr class="toggle-row-display hidden" rowId=@group.Key>
						<td></td>
						<td><input type="checkbox" class="check" check-tier="@group.Key"></td>
						<td>
							<button type="button"
									class="btn btn-primary details-modal-input"
									data-assigned-id='@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(timeEntry))'>
								@timeEntry.Date.ToShortDateString()
							</button>
						</td>
						@foreach (int payClassId in Model.PayClasses.Select(x => x.PayClassId))
						{
							if (timeEntry.PayClassId == payClassId)
							{
								<td>@timeEntry.Duration</td>
							}
							else
							{
								<td>-</td>
							}
						}
						<td>@timeEntry.Duration</td>
					</tr>
				}
			}
			@if (Model.TimeEntriesByUser.Count == 0)
			{
				<tr><td colspan="@(Model.PayClasses.Count + 3)">There are no time entries in this date range, please select a different date range.</td></tr>
			}
		</tbody>
	</table>
	<div class="pageContainer"></div>
</div>

<div class="modal fade" id="time-entry-details-modal" tabindex="-1" role="dialog" aria-labelledby="details-modal-title" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="details-modal-title">Time Entry Details</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="container-fluid">
					<div class="row">
						<div class="col-md-6">User Name:</div>
						<div class="col-md-6" id="modal-details-name"></div>
					</div>
					<div class="row">
						<div class="col-md-6">Customer:</div>
						<div class="col-md-6" id="modal-details-customer"></div>
					</div>
					<div class="row">
						<div class="col-md-6">Project:</div>
						<div class="col-md-6" id="modal-details-project"></div>
					</div>
					<div class="row">
						<div class="col-md-6">Pay Type:</div>
						<div class="col-md-6" id="modal-details-pay-type"></div>
					</div>
					<div class="row">
						<div class="col-md-6">Duration:</div>
						<div class="col-md-6" id="modal-details-duration"></div>
					</div>
					<div class="row">
						<div class="col-md-6">Description:</div>
						<div class="col-md-6" id="modal-details-description"></div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary">Save changes</button>
			</div>
		</div>
	</div>
</div>

@section css {
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
}

@section Scripts {
@*Date range picker dependencies:*@
@Scripts.Render("~/bundles/jqueryui")
@Scripts.Render("~/bundles/moment")
<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>

<script type="text/javascript">
	$(document).ready(function() {
		//toggles the expand icon up or down
		$(".toggle-on-click").click(function () {
			if ($(this).hasClass("fa-chevron-down")) {
				$(this).removeClass("fa-chevron-down");
				$(this).addClass("fa-chevron-up");
			} else {
				$(this).removeClass("fa-chevron-up");
				$(this).addClass("fa-chevron-down");
			}
		});

		$(".toggle-row-display-controller").click(function () {
			var rows = $(".toggle-row-display[rowId='" + $(this).attr("rowId") + "']");
			if (rows.hasClass("hidden")) {
				rows.removeClass("hidden");
			} else {
				rows.addClass("hidden")
			}
		});

		$(".check-all").change(function () {
			$(".check[check-tier=" + $(this).attr("check-all-tier") + "]").prop("checked", $(this).is(":checked")).change();
		});

		$(function () {
			var start = moment(@(Model.StartDate.ToUniversalTime().Subtract(new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)).TotalMilliseconds));
			var end = moment(@(Model.EndDate.ToUniversalTime().Subtract(new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)).TotalMilliseconds));

			function cb(start, end) {
				$('#review-range span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
			}

			$('#review-range').daterangepicker({
				locale: "us",
				startDate: start,
				endDate: end,
				ranges: {
					'Today': [moment(), moment()],
					'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
					'Last 7 Days': [moment().subtract(6, 'days'), moment()],
					'Last 30 Days': [moment().subtract(29, 'days'), moment()],
					'This Month': [moment().startOf('month'), moment().endOf('month')],
					'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
				}
			}, cb);

			cb(start, end);
		});

		$("#review-range").on("apply.daterangepicker", function (dre, picker) {
			var newForm = jQuery('<form>', {
				'action': '/timetracker/@Model.SubscriptionId/timeentry/review',
				'target': '_top',
				'method': 'get'
			}).append(jQuery('<input>', {
				'name': 'StartDate',
				'value': picker.startDate.toISOString(),
				'type': 'hidden'
			})).append(jQuery('<input>', {
				'name': 'EndDate',
				'value': picker.endDate.toISOString(),
				'type': 'hidden'
			}));
			newForm.appendTo(document.body).submit();
		});

		$('#time-entry-details-modal').on('shown.bs.modal', function () {
			$('#details-modal-input').focus();
		});

		$(".details-modal-input").click(function () {
			var timeEntry = $(this).data("assigned-id");

			$("#modal-details-name").text(timeEntry.FirstName + timeEntry.LastName);
			$("#modal-details-customer").text(timeEntry.CustomerName);
			$("#modal-details-project").text(timeEntry.ProjectName);
			$("#modal-details-pay-type").text(timeEntry.PayClassName);
			$("#modal-details-duration").text(timeEntry.Duration);
			$("#modal-details-description").text(timeEntry.Description || "None");
			$('#time-entry-details-modal').modal();
		});
	});
</script>
}
