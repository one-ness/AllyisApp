@using AllyisApps.ViewModels.TimeTracker.Customer;
@using AllyisApps.ViewModels.TimeTracker.Project;
@using AllyisApps.Services;

@model ManageCustomerViewModel

@{
    DisplayHints.PageBodyId = "tt-customer";
    ViewBag.Title = Strings.CustomerList;
    ViewData["IsManager"] = Model.canEdit;
    Layout = "~/Areas/TimeTracker/Views/Shared/_Layout.cshtml";
    var empty = new EditCustomerInfoViewModel() { OrganizationId = Model.OrganizationId };
    var emptyProj = new EditProjectViewModel();
    var createButtonClass = !Model.canEdit ? "invisible" : "";
}


<div class="row">
    <div class="col-xs-12 col-md-8 col-md-push-2">
        <div class="allyis-action-buttons-top">
            <a href="@Url.Action(ActionConstants.Create, ControllerConstants.Customer)" class="btn btn-default @createButtonClass">@Strings.AddCustomer <i class="fa fa-plus"></i></a>
            <a href="@Url.Action(ActionConstants.Reactivate, ControllerConstants.Customer)" class="btn btn-default @createButtonClass">@Strings.Reactivate <i class="fa fa-plus"></i></a>

            <div class="pull-right">
                <input type="text" id="SearchInput" placeholder=@Strings.SearchPlaceholder class="form-control">
            </div>
        </div>

        <div class="flexbox-row flexbox-row-2-col-collapse">
            <div class="panel panel-info" style="position: relative">
                <div class="panel-heading">
                    <h1 class="panel-title">@Strings.CustomerList</h1>
                </div>
                <div class="panel-body list-group" id="Customers">
                    @foreach (CustomerProjectViewModel customer in Model.Customers)
                    {
                        <a onclick="PopulateProjects('@customer.CustomerInfo.CustomerId')" class="list-group-item" id="@customer.CustomerInfo.CustomerId">
                            <text>@customer.CustomerInfo.Name</text>
                        </a>
                    }
                    <br />
                </div>
            </div>

            <div class="panel panel-info">
                <div class="panel-heading">
                    <h1 class="panel-title">@Strings.Project</h1>
                </div>
                <div class="panel-body list-group" id="Projects">
                    <!--projects belong to chosen customer will be populated here-->
                </div>
            </div>
        </div>
        <div class="pull-left">
            <a onclick="EditCustomer()" class="glyphicon glyphicon-pencil"></a>
            <a onclick="DeleteCustomer()" class="glyphicon glyphicon-remove"></a>
            <a href="@Url.Action(ActionConstants.Create, ControllerConstants.Customer)" class="glyphicon glyphicon-plus"></a>
        </div>
        <div class="col-md-5 col-md-offset-5" style="padding-left: 4%">
            <div class="pull-left">
                <a onclick="EditProject()" class="glyphicon glyphicon-pencil"></a>
                <a onclick="DeleteProject()" class="glyphicon glyphicon-remove"></a>
                <a onclick="CreateProject()" class="glyphicon glyphicon-plus"></a>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script type="text/javascript">
        var selectedCust = 1;
        var selectedProj;

        if (@Model.Customers.Count() > 0)
        {
            $(document).ready(function () {
                PopulateProjects(@Model.Customers.First().CustomerInfo.CustomerId)
            })
        }

        function SelectProject(projectId)
        {
            $("#project-" + selectedProj).css("font-weight", "Normal");
            selectedProj = projectId;
            $("#project-" + selectedProj).css("font-weight", "Bold");
        }

        function PopulateProjects(chosenCustomerId) {
            $("#" + selectedCust).css("font-weight", "Normal");
            selectedCust = chosenCustomerId;
            $("#" + selectedCust).css("font-weight", "Bold");
            $.ajax({
                    type: 'POST',
                    cache: false,
                    url: '@Url.Action("PopulateProjects", "Customer")',
                    data: { customerId: chosenCustomerId },
                    success: function (response) {
                        $("#Projects").empty();
                        $("#Projects").html(response);
                    }
            });
        }

        function EditCustomer()
        {
            var link = '@Url.Action(ActionConstants.Edit, ControllerConstants.Customer, new { id = "-1" })';
            link = link.replace("-1", selectedCust);
            window.location = link;
        }

        function DeleteCustomer()
        {
            if (confirm("Delete customer " + $("#" + selectedCust).text().trim() + "?"))
            {
                var link = '@Url.Action(ActionConstants.Delete, ControllerConstants.Customer, new { id = "-1" })';
                link = link.replace("-1", selectedCust);
                window.location = link;
            }
        }

        function EditProject()
        {
            var link = '@Url.Action(ActionConstants.Edit, ControllerConstants.Project, new { id = "-1" })';
            link = link.replace("-1", selectedProj);
            window.location = link;
        }

        function DeleteProject()
        {
            if (confirm("Delete project " + $("#project-" + selectedProj).text().trim() + "?"))
            {
                var link = '@Url.Action(ActionConstants.Delete, ControllerConstants.Project, new { id = "-1" })';
                link = link.replace("-1", selectedProj);
                window.location = link;
            }
        }

        function CreateProject()
        {
                var link = '@Url.Action(ActionConstants.Create, ControllerConstants.Project, new { id = "-1" })';
                link = link.replace("-1", selectedCust);
                window.location = link;
        }
    </script>
}