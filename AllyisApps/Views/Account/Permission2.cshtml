@using AllyisApps.ViewModels.Auth;

@model ManagePermissionsViewModel
@Html.HiddenFor(m => m.OrganizationId)
@{
	ViewBag.Title = Strings.Permissions;
	Layout = "~/Views/Shared/_Layout.cshtml";

	bool hasTimeTracker = Model.Subscriptions.Where(s => s.ProductId == Model.TimeTrackerId).Any();
	bool hasExpenseTracker = Model.Subscriptions.Where(s => s.ProductId == Model.ExpenseTrackerId).Any();

	Dictionary<int, string> organizationRoles = new Dictionary<int, string>
	{
		{ (int)AllyisApps.Services.OrganizationRole.Member, Strings.Member },
		{ (int)AllyisApps.Services.OrganizationRole.Owner, Strings.Owner }
	};
	Dictionary<int, string> ttRoles = new Dictionary<int, string>
	{
		{ (int)AllyisApps.Services.TimeTrackerRole.User, Strings.User },
		{ (int)AllyisApps.Services.TimeTrackerRole.Manager, Strings.Manager },
		{ (int)AllyisApps.Services.TimeTrackerRole.NotInProduct, Strings.Unassigned }
	};

	Dictionary<int, string> etRoles = new Dictionary<int, string>
	{
		{ (int)AllyisApps.Services.ExpenseTrackerRole.User, Strings.User },
		{ (int)AllyisApps.Services.ExpenseTrackerRole.Manager, Strings.Manager },
		{ (int)AllyisApps.Services.ExpenseTrackerRole.SuperUser, "Super User" },
		{ (int)AllyisApps.Services.ExpenseTrackerRole.NotInProduct, Strings.Unassigned }
	};


	Dictionary<string, int> setOrganizationRoles = new Dictionary<string, int>
	{
		{ Strings.RemoveOrg, -1 },
		{ Strings.SetMember, (int)AllyisApps.Services.OrganizationRole.Member },
		{ Strings.SetOwner, (int)AllyisApps.Services.OrganizationRole.Owner }
	};
	Dictionary<string, int> setTTRoles = new Dictionary<string, int>
	{
		{ Strings.RemoveFromSubscription, 0 },
		{ Strings.SetUser, (int)AllyisApps.Services.TimeTrackerRole.User },
		{ Strings.SetManager, (int)AllyisApps.Services.TimeTrackerRole.Manager }
	};

	Dictionary<string, int> setETRoles = new Dictionary<string, int>
	{
		{ Strings.RemoveFromSubscription, 0},
		{ Strings.SetUser, (int)AllyisApps.Services.ExpenseTrackerRole.User },
		{ Strings.SetManager, (int)AllyisApps.Services.ExpenseTrackerRole.Manager },
		{ "Set Super User", (int)AllyisApps.Services.ExpenseTrackerRole.SuperUser }
	};
}

@Html.AntiForgeryToken()

<ul class="nav allyis-tabs">
	<li class="selected" id="OrganizationTab">@Strings.Organization</li>
	@if (hasTimeTracker)
	{
		<li id="TimeTrackerTab">@Strings.TimeTracker</li>
    }
    @if(hasExpenseTracker)
    {
        <li id="ExpenseTrackerTab">@Strings.ExpenseTracker</li>
    }
</ul>
<div class="panel panel-default">
    <div class="panel-body" style="padding: 0px;">
        <table class="table table-hover table-condensed">
            <thead class="panel-heading">
                <tr class="no-border">
                    <th style="width: 6%;"></th>
                    <th style="width: 47%;">@Strings.User</th>
                    <th style="width: 47%;" class="tab-OrganizationTab">@Strings.OrganizationRole</th>
					<th style="width: 47%; display: none;" class="tab-ExpenseTrackerTab">@Strings.ExpenseTrackerRole</th>
                    @if (hasTimeTracker)
                    {
                        <th class="tab-TimeTrackerTab" style="display: none; width: 47%;">@Strings.TimeTrackerRole</th>
                        <th class="tab-TimeTrackerTab" style="display: none; width: 47%;">@Strings.ExpenseTrackerRole</th>
                    }
                </tr>
                <tr class="double-bottom-border">
                    <td class="checked">
                        <input type="checkbox" class="all-check" />
                    </td>
                    <td>
                        <input type="search" placeholder="@Strings.UserSearchPlaceholder" id="userSearch" class="form-control" />
                    </td>
                    <td class="tab-OrganizationTab">
                        <select id="organizationRoleFilter" class="form-control">
                            <option>@Strings.Any</option>
                            @foreach (string role in organizationRoles.Values)
                            {
                                <option>@role</option>
                            }
                        </select>
                    </td>
                    @if (hasTimeTracker)
                    {
                        <td class="tab-TimeTrackerTab" style="display: none;">
                            <select id="ttRoleFilter" class="form-control">
                                <option>@Strings.Any</option>
                                @foreach (string ttrole in ttRoles.Values)
                                {
                                    <option>@ttrole</option>
                                }
                            </select>
                        </td>
                    }
                    @if(hasExpenseTracker)
                    {
                        <td class="tab-ExpenseTrackerTab" style="display: none;">
                            <select id="etRoleFilter" class=" = form-control">
                                <option>@Strings.Any</option>
                                @foreach(string etrole in etRoles.Values)
                                {
                                    <option>@etrole</option>
                                }
                            </select>
                        </td>
                    }
                </tr>
            </thead>

            @foreach (UserPermissionsViewModel user in Model.Users)
            {
				var fullName = string.Format("{0} {1}", user.FirstName, user.LastName);

                <tr class="userRow" data-id="@user.UserId" data-name="@user.Email">
                    <td class="checked">
                        <input type="checkbox" id="check" />
                    </td>
                    <td id="name">@fullName</td>
                    <td id="organizationRole" class="tab-OrganizationTab">@organizationRoles[user.OrganizationRoleId]</td>
                    @if (hasTimeTracker)
					{
						<td id="ttRole" class="tab-TimeTrackerTab" style="display: none;">@ttRoles[user.ProductRoleIds[Model.TimeTrackerSubIndex]]</td>
                    }
                    @if(hasExpenseTracker)
                    {
                        <td id="etRole" class="tab-ExpenseTrackerTab" style="display: none;">@etRoles[user.ProductRoleIds[Model.ExpenseTrackerSubIndex]]</td>
                    }
                </tr>
            }

            @*This last blank row is just an easy way to have a border at the bottom of the table content*@
            <tr id="tableEnd" class="nohover">
                <td></td>
                <td></td>
                <td class="tab-OrganizationTab"></td>
                @if (hasTimeTracker) { <td class="tab-TimeTrackerTab" style="display: none;"></td> }
            </tr>
        </table>
        <div class="pageContainer">
            @*This container is populated by javascript in allyis-account-permission2.js*@
        </div>
    </div>
    <div class="panel-footer" style="height: 54px; position: relative;">
        <div class="col-xs-2 col-sm-1 col-md-1" style="text-align: right; vertical-align: middle; line-height: 33px; padding-right: 0px;">
            @Strings.Actions
        </div>
        <div class="col-xs-6 col-sm-6 col-md-5 col-lg-4">
            <select class="form-control tab-OrganizationTab" id="orgActionSelect">
                <optgroup label="@Strings.Organization">
                    @foreach (string setOrganizationRole in setOrganizationRoles.Keys)
                    {
                        <option>@setOrganizationRole</option>
                    }
                </optgroup>
            </select>
			@if (hasTimeTracker)
			{
				<select class="form-control tab-TimeTrackerTab" id="ttActionSelect" style="display: none;">
					<optgroup label="@Strings.TimeTracker">
						@foreach (string setTTRole in setTTRoles.Keys)
						{
							<option>@setTTRole</option>
						}
					</optgroup>
				</select>
			}
            @if (hasExpenseTracker)
            {
                <select class="form-control tab-ExpenseTrackerTab" id="etActionSelect" style="display: none">
                    <optgroup label="@Strings.ExpenseTracker">
                        @foreach(string setETRole in setETRoles.Keys)
                        {
                            <option>@setETRole</option>
                        }
                    </optgroup>
                </select>
            }
        </div>

        <div class="bottom-right">
            <a href="@Url.Action(ActionConstants.ManageOrg, ControllerConstants.Account, new { id = Model.OrganizationId })" class="btn btn-default"> @Strings.Cancel </a>
            <input type="button" class="btn btn-primary" id="do-it" value="@Strings.Save" />
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        orgActions = @Html.Raw(Json.Encode(setOrganizationRoles));
        ttActions = @Html.Raw(Json.Encode(setTTRoles));
        etActions = @Html.Raw(Json.Encode(setETRoles));
        confirmMessage = "@Html.Raw(Strings.RemoveFromOrgNoName)";
    </script>
    <script src="~/Scripts/allyis-account-permission2.js" type="text/javascript"></script>
    <script src="~/Scripts/allyis-pages-with-filter.js" type="text/javascript"></script>
    @*@Scripts.Render("~/bundles/AccountPermission2");*@
    <script type="text/javascript">        @*Filters can only be set up after the above script is loaded*@
        pwf.setPageLimit(15);
        pwf.setRowClass("userRow");
        pwf.setCheckBoxSelector("#check");
        pwf.addFilter("#userSearch", "search", "#name");
        pwf.addFilter('#organizationRoleFilter', 'dropDown', "#organizationRole", "@Strings.Any");
        if('@hasTimeTracker' == 'True') pwf.addFilter('#ttRoleFilter', 'dropDown', "#ttRole", "@Strings.Any");
        if (sessionStorage.getItem("/ManagePermissionsPage") != null)
        {
            pwf.setPreviouslySelectedPage(sessionStorage.getItem("/ManagePermissionsPage"))
        }
    </script>
}
