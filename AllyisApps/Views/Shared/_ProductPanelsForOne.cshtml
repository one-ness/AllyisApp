@using AllyisApps.Services;
@using AllyisApps.ViewModels.Shared;
@model SubscriptionsViewModel

@{
	string linkTextOverride = ViewBag.ProductPanelLinkTextOverride;

	Func<int, string, string, dynamic> package = (product_id, title, image) =>
		new
		{
			product_id = product_id,
			title = title,
			image_url = image,
			query = (from entry in Model.Subscriptions
					 where entry.ProductId == product_id && entry.CanViewSubscription
					 orderby entry.OrganizationName
					 select new
					 {
						 ProductId = entry.ProductId,
						 OrganizationId = entry.OrganizationId,
						 OrganizationName = entry.OrganizationName//,
						 //MemberSince = entry.CreatedUTC.ToLocalTime()
					 }).ToArray(),
		};

	List<dynamic> product_boxes = new List<dynamic>();

	foreach (Product prod in Model.ProductList)
	{
		product_boxes.Add(package(prod.ProductId, prod.ProductName, string.Format("Content/icons/{0}.png", prod.ProductName.Replace(" ", ""))));
	}
}

@foreach (var product_box in product_boxes)
{
    int product_id = product_box.product_id;
    string title = product_box.title;
    string image_url = product_box.image_url;
    IEnumerable<dynamic> query = product_box.query;
    if (query.Any())
    {
        var the_only_one = query.First();
        if (Model.TimeTrackerViewSelf)
        {
            <div class="panel-wrap panel-wrap-one" style="width: 300px;">
                <a href="@Url.Action(ActionConstants.ApplicationRedirect, ControllerConstants.Account, routeValues: new { productId = product_id, organizationId = the_only_one.OrganizationId })" style="text-decoration: none">
                    <div class="panel panel-default">
                        <div class="panel-heading" style="display: table; width: 100%; height: 100%;">
                            <div class="left" style="display: table-cell; width: 30%; text-align: center; vertical-align: middle;">
                                <img src="~/@image_url" alt="@title" />
                            </div>
                            <div class="right" style="display: table-cell;">
                                <h3>
                                    @Strings.TimeTracker
                                </h3>
                                <p>@Strings.TimeTrackerDescription</p>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        }
    }
}
